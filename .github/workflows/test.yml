name: Test Jekyll Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: Generate Website
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build JavaScript and CSS bundles
        run: npm run build

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Create minimal test site
        run: |
          mkdir -p test_site
          cd test_site
          cat > Gemfile << 'EOF'
          source "https://rubygems.org"
          gem "jekyll", "~> 4.0"
          gem "jekyll-theme-conference", path: ".."
          EOF
          cat > _config.yml << 'EOF'
          theme: jekyll-theme-conference
          collections:
            talks:
              output: true
            speakers:
              output: true
            rooms:
              output: true
          defaults:
            - scope:
                path: ""
                type: talks
              values:
                layout: talk
            - scope:
                path: ""
                type: speakers
              values:
                layout: speaker
            - scope:
                path: ""
                type: rooms
              values:
                layout: room
          EOF
          mkdir -p _data
          cp ../_data/program.yml _data/ 2>/dev/null || echo "program: []" > _data/program.yml
          mkdir -p _talks _speakers _rooms
          echo "---\n---" > _talks/test.md
          echo "---\n---" > _speakers/test.md
          echo "---\n---" > _rooms/test.md

      - name: Install test site dependencies
        run: |
          cd test_site
          bundle install

      - name: Build test site
        run: |
          cd test_site
          bundle exec jekyll build -d _site/
        env:
          JEKYLL_ENV: production
